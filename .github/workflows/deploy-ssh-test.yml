name: SSH Deploy Test (diagnostic)
on:
  workflow_dispatch:

jobs:
  test_ssh:
    name: Test SSH Connection
    runs-on: ubuntu-latest
    environment: Hetzner production
    steps:
      - name: Verify secrets
        run: |
          echo "HETZNER_HOST length: ${#HOST}"
          echo "HETZNER_USER length: ${#USER}"
          echo "HETZNER_SSH_KEY length: ${#KEY}"
          [ -z "$HOST" ] && echo "::error::HETZNER_HOST is empty" && exit 1
          [ -z "$USER" ] && echo "::error::HETZNER_USER is empty" && exit 1
          [ -z "$KEY" ] && echo "::error::HETZNER_SSH_KEY is empty" && exit 1
          echo "All secrets present"
        env:
          HOST: ${{ secrets.HETZNER_HOST }}
          USER: ${{ secrets.HETZNER_USER }}
          KEY: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Test connectivity
        run: nc -z -w 10 ${{ secrets.HETZNER_HOST }} 22 && echo "âœ… Port 22 open" || echo "âŒ Port 22 closed"

      - name: SSH verbose connect
        env:
          SSH_KEY: ${{ secrets.HETZNER_SSH_KEY }}
          SSH_HOST: ${{ secrets.HETZNER_HOST }}
          SSH_USER: ${{ secrets.HETZNER_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          echo "=== Key info ==="
          ssh-keygen -l -f ~/.ssh/deploy_key 2>&1 || echo "::warning::Cannot read key"
          head -1 ~/.ssh/deploy_key

          echo "=== Host keyscan ==="
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>&1

          echo "=== SSH connect (verbose) ==="
          ssh -vvv -i ~/.ssh/deploy_key -o ConnectTimeout=30 -o BatchMode=yes \
            "$SSH_USER@$SSH_HOST" "echo 'SSH connection successful! hostname: $(hostname)'" \
            2>&1 | tail -100

          rm -f ~/.ssh/deploy_key
