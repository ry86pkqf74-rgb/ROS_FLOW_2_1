# AI CI fixer: on CI failure (PRs + main), open/update a PR with fixes and enable squash auto-merge.
# Does not run on forks. Never pushes to main. Stops after 3 attempts with "needs human" summary.
name: AI Fix CI

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

# Do not run when the failed run was from a fork (only our repo)
env:
  MAX_ATTEMPTS: 3

jobs:
  ai-fix:
    name: AI fix and open PR
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.repository.full_name == github.repository
    permissions:
      contents: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout at failing commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set branch and attempt
        id: meta
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID="${{ github.event.workflow_run.id }}"
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
          # If we're already on a ci-fix branch, find existing PR and parse attempt
          if [[ "$HEAD_BRANCH" == ci-fix/* ]]; then
            PR=$(gh pr list --head "$HEAD_BRANCH" --state open --json number,body --jq '.[0]')
            if [[ -n "$PR" ]]; then
              BODY=$(echo "$PR" | jq -r '.body')
              ATTEMPT=$(echo "$BODY" | sed -n 's/.*Attempt \([1-3]\) of 3.*/\1/p' || echo "1")
              ATTEMPT=$((ATTEMPT + 0))
              if [[ $ATTEMPT -ge ${{ env.MAX_ATTEMPTS }} ]]; then
                echo "attempt=$ATTEMPT" >> "$GITHUB_OUTPUT"
                echo "needs_human=true" >> "$GITHUB_OUTPUT"
                echo "branch=$HEAD_BRANCH" >> "$GITHUB_OUTPUT"
                echo "pr_number=$(echo "$PR" | jq -r '.number')" >> "$GITHUB_OUTPUT"
                exit 0
              fi
              ATTEMPT=$((ATTEMPT + 1))
              FIX_BRANCH="$HEAD_BRANCH"
              PR_NUM=$(echo "$PR" | jq -r '.number')
              echo "pr_number=$PR_NUM" >> "$GITHUB_OUTPUT"
            else
              ATTEMPT=1
              FIX_BRANCH="ci-fix/run-${RUN_ID}"
            fi
          else
            ATTEMPT=1
            FIX_BRANCH="ci-fix/run-${RUN_ID}"
          fi
          echo "attempt=$ATTEMPT" >> "$GITHUB_OUTPUT"
          echo "fix_branch=$FIX_BRANCH" >> "$GITHUB_OUTPUT"
          echo "base_branch=$HEAD_BRANCH" >> "$GITHUB_OUTPUT"
          echo "needs_human=false" >> "$GITHUB_OUTPUT"

      - name: Stop after max attempts (needs human)
        if: steps.meta.outputs.needs_human == 'true'
        run: |
          echo "## Needs human" >> "$GITHUB_STEP_SUMMARY"
          echo "CI fixer reached ${{ env.MAX_ATTEMPTS }} attempts. Please fix CI manually." >> "$GITHUB_STEP_SUMMARY"
          PR_NUM="${{ steps.meta.outputs.pr_number }}"
          if [[ -n "$PR_NUM" ]]; then
            gh pr comment "$PR_NUM" --body "**Needs human:** AI fixer stopped after ${{ env.MAX_ATTEMPTS }} attempts. Please fix CI failures manually."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create/checkout fix branch
        if: steps.meta.outputs.needs_human != 'true'
        run: |
          git checkout -B "${{ steps.meta.outputs.fix_branch }}"

      - name: Set up Node for fixer script
        if: steps.meta.outputs.needs_human != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run AI fixer (Anthropic → OpenAI → Anthropic)
        id: fixer
        if: steps.meta.outputs.needs_human != 'true'
        env:
          RUN_ID: ${{ github.event.workflow_run.id }}
          ATTEMPT: ${{ steps.meta.outputs.attempt }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OUT_PATCH: fix.patch
        run: |
          node .github/scripts/ai-fix-ci.mjs

      - name: Apply patch
        if: steps.meta.outputs.needs_human != 'true' && hashFiles('fix.patch') != ''
        run: |
          patch -p1 < fix.patch || true

      - name: Check for changes
        id: changes
        if: steps.meta.outputs.needs_human != 'true'
        run: |
          git status -s
          if [[ -n $(git status -s) ]]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push
        if: steps.meta.outputs.needs_human != 'true' && steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "fix(ci): AI fix attempt ${{ steps.meta.outputs.attempt }} of ${{ env.MAX_ATTEMPTS }}"
          git push -u origin "${{ steps.meta.outputs.fix_branch }}" --force

      - name: Create PR
        if: steps.meta.outputs.needs_human != 'true' && steps.changes.outputs.has_changes == 'true' && steps.meta.outputs.pr_number == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base "${{ steps.meta.outputs.base_branch }}" \
            --head "${{ steps.meta.outputs.fix_branch }}" \
            --title "fix(ci): Auto-fix CI failure (attempt ${{ steps.meta.outputs.attempt }} of ${{ env.MAX_ATTEMPTS }})" \
            --body "Attempt ${{ steps.meta.outputs.attempt }} of ${{ env.MAX_ATTEMPTS }}

Automated fix for [CI run ${{ github.event.workflow_run.id }}](${{ github.event.workflow_run.html_url }}).

Squash merge will be enabled once CI passes."

      - name: Update PR body (attempt count)
        if: steps.meta.outputs.needs_human != 'true' && steps.changes.outputs.has_changes == 'true' && steps.meta.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ steps.meta.outputs.pr_number }} \
            --body "Attempt ${{ steps.meta.outputs.attempt }} of ${{ env.MAX_ATTEMPTS }}

Automated fix for [CI run ${{ github.event.workflow_run.id }}](${{ github.event.workflow_run.html_url }}).

Squash merge will be enabled once CI passes."

      - name: Enable squash auto-merge
        if: steps.meta.outputs.needs_human != 'true' && steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.meta.outputs.pr_number }}"
          if [[ -z "$PR_NUM" ]]; then
            PR_NUM=$(gh pr list --head "${{ steps.meta.outputs.fix_branch }}" --state open -q '.[0].number')
          fi
          if [[ -n "$PR_NUM" ]]; then
            gh pr merge "$PR_NUM" --auto --squash
          fi
