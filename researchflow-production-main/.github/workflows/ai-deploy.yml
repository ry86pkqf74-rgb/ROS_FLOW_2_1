name: AI Deployment Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'ai/**'
      - 'docker-compose.ai.yml'
      - '.github/workflows/ai-deploy.yml'
      - 'deploy/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      rollout_strategy:
        description: 'Rollout strategy'
        required: true
        type: choice
        options:
          - canary
          - blue-green
          - rolling

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  OLLAMA_VERSION: latest
  TRITON_VERSION: 24.02-py3

jobs:
  validate:
    name: Validate AI Models and Configuration
    runs-on: ubuntu-latest
    outputs:
      model-list: ${{ steps.models.outputs.list }}
      config-hash: ${{ steps.config.outputs.hash }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.ai.yml
        run: |
          echo "Validating Docker Compose configuration..."
          docker-compose -f docker-compose.ai.yml config > /dev/null
          if [ $? -eq 0 ]; then
            echo "✓ docker-compose.ai.yml is valid"
          else
            echo "✗ docker-compose.ai.yml validation failed"
            exit 1
          fi

      - name: Validate AI model files
        id: models
        run: |
          echo "Validating AI model configurations..."
          model_list=$(find . -name "*.model" -o -name "*.onnx" -o -name "*.pt" | jq -R -s -c 'split("\n")[:-1]')
          echo "list=$model_list" >> $GITHUB_OUTPUT
          
          if [ -z "$model_list" ]; then
            echo "⚠ No model files found in repository"
          else
            echo "✓ Found models: $model_list"
          fi

      - name: Check model checksums
        run: |
          if [ -f "deploy/model-checksums.txt" ]; then
            echo "Verifying model integrity..."
            sha256sum -c deploy/model-checksums.txt
            if [ $? -eq 0 ]; then
              echo "✓ All model checksums verified"
            else
              echo "✗ Model checksum verification failed"
              exit 1
            fi
          fi

      - name: Validate Prometheus configuration
        run: |
          echo "Validating Prometheus configuration..."
          if [ -f "deploy/prometheus.yml" ]; then
            docker run --rm -v $(pwd):/workspace prom/prometheus:latest \
              promtool check config /workspace/deploy/prometheus.yml
            if [ $? -eq 0 ]; then
              echo "✓ Prometheus configuration is valid"
            else
              echo "✗ Prometheus configuration validation failed"
              exit 1
            fi
          fi

      - name: Validate alert rules
        run: |
          echo "Validating alert rules..."
          if [ -f "deploy/alert-rules.yml" ]; then
            docker run --rm -v $(pwd):/workspace prom/prometheus:latest \
              promtool check rules /workspace/deploy/alert-rules.yml
            if [ $? -eq 0 ]; then
              echo "✓ Alert rules are valid"
            else
              echo "✗ Alert rules validation failed"
              exit 1
            fi
          fi

      - name: Hash configuration
        id: config
        run: |
          CONFIG_HASH=$(sha256sum docker-compose.ai.yml deploy/prometheus.yml deploy/alert-rules.yml | sha256sum | cut -d' ' -f1)
          echo "hash=$CONFIG_HASH" >> $GITHUB_OUTPUT
          echo "Configuration hash: $CONFIG_HASH"

      - name: Upload validation artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: validation-report
          path: |
            deploy/prometheus.yml
            deploy/alert-rules.yml
            docker-compose.ai.yml

  check-feature-flags:
    name: Verify Feature Flags
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check feature flag definitions
        run: |
          echo "Checking feature flag status..."
          if [ ! -f "deploy/feature-flags.json" ]; then
            echo "✓ Feature flag file not required"
            exit 0
          fi
          
          # Validate JSON structure
          jq empty deploy/feature-flags.json
          if [ $? -eq 0 ]; then
            echo "✓ Feature flag JSON is valid"
            jq '.' deploy/feature-flags.json
          else
            echo "✗ Feature flag JSON is invalid"
            exit 1
          fi

      - name: Verify flag compatibility
        run: |
          echo "Verifying feature flag compatibility..."
          # Check that all flags have required fields
          if [ -f "deploy/feature-flags.json" ]; then
            jq '.flags[] | select(.name == null or .rollout == null)' deploy/feature-flags.json
            if [ $? -eq 0 ]; then
              echo "✗ Some flags missing required fields"
              exit 1
            fi
            echo "✓ All feature flags have required fields"
          fi

  build-images:
    name: Build AI Service Images
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      matrix:
        service: [faiss-server]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./services/${{ matrix.service }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [validate, check-feature-flags, build-images]
    if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    environment:
      name: staging
      url: https://staging-ai.researchflow.internal
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_STAGING }}
          aws-region: us-west-2

      - name: Deploy to staging
        run: |
          set -e
          echo "Deploying AI services to staging..."
          
          # Set staging environment variables
          export ENVIRONMENT=staging
          export OLLAMA_NUM_PARALLEL=2
          export OLLAMA_NUM_THREAD=4
          export FAISS_CACHE_SIZE=5GB
          
          # Pull latest images
          docker-compose -f docker-compose.ai.yml pull
          
          # Start services
          docker-compose -f docker-compose.ai.yml up -d
          
          # Wait for services to be healthy
          sleep 30
          
          echo "✓ Staging deployment completed"

      - name: Run smoke tests
        run: |
          set -e
          echo "Running smoke tests on staging..."
          
          # Test Ollama
          if curl -f http://localhost:11434/api/tags; then
            echo "✓ Ollama is healthy"
          else
            echo "✗ Ollama health check failed"
            exit 1
          fi
          
          # Test Triton
          if curl -f http://localhost:8000/v2/health/ready; then
            echo "✓ Triton is healthy"
          else
            echo "✗ Triton health check failed"
            exit 1
          fi
          
          # Test FAISS
          if curl -f http://localhost:5000/health; then
            echo "✓ FAISS is healthy"
          else
            echo "✗ FAISS health check failed"
            exit 1
          fi

      - name: Run integration tests
        run: |
          set -e
          echo "Running integration tests..."
          
          # Test AI inference pipeline
          if [ -f "tests/ai/integration_test.sh" ]; then
            bash tests/ai/integration_test.sh
          else
            echo "⚠ Integration tests not found"
          fi

      - name: Verify metrics collection
        run: |
          set -e
          echo "Verifying Prometheus metrics collection..."
          
          # Wait for metrics to be scraped
          sleep 60
          
          # Query Prometheus for AI metrics
          QUERY_URL="http://localhost:9090/api/v1/query"
          
          # Check if we have Ollama metrics
          OLLAMA_METRICS=$(curl -s "$QUERY_URL?query=ollama_tokens_total" | jq '.data.result | length')
          if [ "$OLLAMA_METRICS" -gt 0 ]; then
            echo "✓ Ollama metrics are being collected"
          else
            echo "⚠ Ollama metrics not found yet"
          fi

      - name: Validate alert rules
        run: |
          echo "Validating alert rule execution..."
          ALERT_RULES=$(curl -s http://localhost:9090/api/v1/rules | jq '.data.groups[].rules[].alert' | wc -l)
          echo "Active alert rules: $ALERT_RULES"

      - name: Upload staging logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: staging-deployment-logs
          path: /var/log/researchflow-ai/
          retention-days: 7

  deploy-production:
    name: Deploy to Production (Canary)
    runs-on: ubuntu-latest
    needs: [validate, check-feature-flags, deploy-staging]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://ai.researchflow.internal
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_PRODUCTION }}
          aws-region: us-west-2

      - name: Deploy canary (10% traffic)
        run: |
          set -e
          echo "Deploying 10% canary to production..."
          
          export ENVIRONMENT=production
          export CANARY_PERCENTAGE=10
          
          # Deploy with reduced resource allocation for canary
          docker-compose -f docker-compose.ai.yml up -d --scale ollama=1
          
          echo "✓ Canary deployment (10%) completed"

      - name: Monitor canary metrics
        timeout-minutes: 15
        run: |
          set -e
          echo "Monitoring canary deployment metrics for 10 minutes..."
          
          DURATION=600  # 10 minutes
          CHECK_INTERVAL=30
          ELAPSED=0
          ERROR_THRESHOLD=0.05  # 5% error rate
          LATENCY_THRESHOLD=5000  # 5 seconds in ms
          
          while [ $ELAPSED -lt $DURATION ]; do
            echo "Checking metrics... ($ELAPSED/$DURATION seconds)"
            
            # Query error rate
            ERROR_RATE=$(curl -s 'http://localhost:9090/api/v1/query?query=rate(ai_inference_errors_total[5m])' | \
              jq '.data.result[0].value[1]' 2>/dev/null || echo "0")
            
            # Query latency
            LATENCY=$(curl -s 'http://localhost:9090/api/v1/query?query=rate(ai_inference_duration_ms_sum[5m])' | \
              jq '.data.result[0].value[1]' 2>/dev/null || echo "0")
            
            echo "  Error rate: $ERROR_RATE | Latency: $LATENCY ms"
            
            # Check thresholds
            if (( $(echo "$ERROR_RATE > $ERROR_THRESHOLD" | bc -l) )); then
              echo "✗ Error rate exceeded threshold: $ERROR_RATE > $ERROR_THRESHOLD"
              exit 1
            fi
            
            sleep $CHECK_INTERVAL
            ELAPSED=$((ELAPSED + CHECK_INTERVAL))
          done
          
          echo "✓ Canary metrics verified"

      - name: Promote to 50% traffic
        if: success()
        run: |
          echo "Promoting to 50% traffic..."
          export CANARY_PERCENTAGE=50
          docker-compose -f docker-compose.ai.yml up -d --scale ollama=2
          echo "✓ Promoted to 50% traffic"

      - name: Monitor 50% deployment
        timeout-minutes: 10
        if: success()
        run: |
          echo "Monitoring 50% deployment..."
          sleep 300  # Monitor for 5 minutes
          echo "✓ 50% deployment metrics verified"

      - name: Promote to 100% traffic
        if: success()
        run: |
          echo "Promoting to 100% traffic..."
          export CANARY_PERCENTAGE=100
          docker-compose -f docker-compose.ai.yml up -d --scale ollama=4
          echo "✓ Promoted to 100% traffic"

      - name: Final health check
        run: |
          set -e
          echo "Running final production health checks..."
          
          # Health check all services
          SERVICES=("ollama" "triton" "faiss" "redis" "prometheus" "grafana")
          
          for service in "${SERVICES[@]}"; do
            if docker-compose -f docker-compose.ai.yml ps $service | grep -q "Up"; then
              echo "✓ $service is running"
            else
              echo "✗ $service is not running"
              exit 1
            fi
          done

      - name: Post-deployment notification
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = context.job.status === 'success' ? '✓ Success' : '✗ Failed';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `AI Deployment Pipeline: ${status}\n\n- Environment: Production\n- Deployment: Canary → 50% → 100%\n- Timestamp: ${new Date().toISOString()}`
            });

      - name: Rollback on failure
        if: failure()
        run: |
          set -e
          echo "Triggering rollback due to deployment failure..."
          
          # Revert to previous version
          docker-compose -f docker-compose.ai.yml down
          git checkout HEAD~1 docker-compose.ai.yml
          docker-compose -f docker-compose.ai.yml up -d
          
          echo "✗ Rollback completed"
          exit 1

      - name: Upload production logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: production-deployment-logs
          path: /var/log/researchflow-ai/
          retention-days: 30
