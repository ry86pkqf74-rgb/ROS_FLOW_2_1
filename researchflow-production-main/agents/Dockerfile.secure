# Multi-stage secure Dockerfile for ResearchFlow Agents
# Optimized for production deployment with security hardening

#=============================================================================
# Stage 1: Build Dependencies
#=============================================================================
FROM python:3.11-slim as builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /build

# Copy requirements first (for better caching)
COPY requirements.txt .

# Create virtual environment and install dependencies
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install Python dependencies
RUN pip install --no-cache-dir --upgrade pip wheel setuptools && \
    pip install --no-cache-dir -r requirements.txt

#=============================================================================
# Stage 2: Security Scan (Optional)
#=============================================================================
FROM builder as security-scan

# Install security scanning tools
RUN pip install --no-cache-dir safety bandit

# Copy source code for scanning
COPY . .

# Run security scans
RUN safety check --json || echo "Safety check completed with warnings" && \
    bandit -r . -f json -o /tmp/bandit-report.json || echo "Bandit scan completed with warnings"

#=============================================================================
# Stage 3: Production Runtime
#=============================================================================
FROM python:3.11-slim as runtime

# Install runtime dependencies only
RUN apt-get update && apt-get install -y \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Create non-root user for security
RUN groupadd -r agentuser && useradd -r -g agentuser agentuser

# Create application directories with proper permissions
RUN mkdir -p /app /data/logs /data/artifacts /data/cache && \
    chown -R agentuser:agentuser /app /data

# Copy virtual environment from builder
COPY --from=builder --chown=agentuser:agentuser /opt/venv /opt/venv

# Set PATH to use virtual environment
ENV PATH="/opt/venv/bin:$PATH"

# Set working directory
WORKDIR /app

# Copy application code with proper ownership
COPY --chown=agentuser:agentuser . .

# Security: Remove unnecessary files
RUN find /app -name "*.pyc" -delete && \
    find /app -name "__pycache__" -type d -exec rm -rf {} + || true && \
    rm -rf /app/.git /app/.pytest_cache /app/tests/coverage* /app/coverage_html

# Set environment variables for security
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONPATH=/app \
    PATH="/opt/venv/bin:$PATH"

# Security: Set resource limits in environment
ENV AGENT_MAX_MEMORY_MB=2048 \
    AGENT_MAX_CPU_TIME=3600 \
    AGENT_MAX_FILE_DESCRIPTORS=1024

# Switch to non-root user
USER agentuser

# Health check with timeout
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python -c "import sys; sys.exit(0)" || exit 1

# Expose metrics port (non-privileged)
EXPOSE 9090

# Set secure file permissions
RUN chmod -R 755 /app && \
    chmod 600 /app/agents/utils/*.py

# Default command with security validation
CMD ["sh", "-c", "\
    echo 'üõ°Ô∏è  Starting security validation...' && \
    python -c 'from agents.utils.security import validate_deployment_security, apply_security_hardening; \
               assert validate_deployment_security(), \"Security validation failed\"; \
               apply_security_hardening(); \
               print(\"‚úÖ Security validation passed\")' && \
    echo 'üöÄ Starting ResearchFlow Agents...' && \
    python -m agents.orchestrator \
"]

# Security labels
LABEL security.scan="enabled" \
      security.non_root="true" \
      security.readonly_rootfs="recommended" \
      maintainer="ResearchFlow Team" \
      version="1.0.0" \
      description="Secure ResearchFlow Agent Runtime"

# Optional: Add security metadata
LABEL org.opencontainers.image.title="ResearchFlow Agents (Secure)" \
      org.opencontainers.image.description="Production-hardened ResearchFlow agent runtime" \
      org.opencontainers.image.vendor="ResearchFlow" \
      org.opencontainers.image.version="1.0.0" \
      org.opencontainers.image.created=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
      org.opencontainers.image.source="https://github.com/researchflow/agents"
