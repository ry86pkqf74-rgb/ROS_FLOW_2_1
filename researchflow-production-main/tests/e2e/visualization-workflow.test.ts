/**
 * End-to-End Tests - Visualization Workflow
 * 
 * Tests the complete user journey for data visualization:
 * 1. User uploads research data
 * 2. Requests chart generation 
 * 3. Reviews generated figures
 * 4. Manages figure library
 * 5. Exports for manuscript
 * 
 * This test requires:
 * - Running orchestrator service
 * - Running worker service with DataVisualizationAgent
 * - Database connection
 * - Test research project setup
 */

import { describe, test, expect, beforeAll, afterAll, beforeEach, afterEach } from 'vitest';
import puppeteer, { Browser, Page } from 'puppeteer';
import request from 'supertest';\nimport { app } from '../../services/orchestrator/src/app';\n\n// Test configuration\nconst TEST_CONFIG = {\n  FRONTEND_URL: process.env.FRONTEND_URL || 'http://localhost:5173',\n  ORCHESTRATOR_URL: process.env.ORCHESTRATOR_URL || 'http://localhost:3001',\n  WORKER_URL: process.env.WORKER_URL || 'http://localhost:8000',\n  HEADLESS: process.env.E2E_HEADLESS !== 'false',\n  TIMEOUT: 60000, // 1 minute timeout\n};\n\ndescribe('Visualization Workflow E2E', () => {\n  let browser: Browser;\n  let page: Page;\n  let testResearchId: string;\n  let testProjectId: string;\n  let createdFigureIds: string[] = [];\n\n  beforeAll(async () => {\n    // Launch browser\n    browser = await puppeteer.launch({\n      headless: TEST_CONFIG.HEADLESS,\n      defaultViewport: { width: 1280, height: 720 },\n      args: ['--no-sandbox', '--disable-setuid-sandbox'],\n    });\n\n    // Create test research project via API\n    testResearchId = `e2e_research_${Date.now()}`;\n    testProjectId = `e2e_project_${Date.now()}`;\n  }, TEST_CONFIG.TIMEOUT);\n\n  afterAll(async () => {\n    // Cleanup created figures\n    for (const figureId of createdFigureIds) {\n      try {\n        await request(app).delete(`/api/visualization/figure/${figureId}`);\n      } catch (error) {\n        // Ignore cleanup errors\n      }\n    }\n\n    await browser?.close();\n  });\n\n  beforeEach(async () => {\n    page = await browser.newPage();\n    \n    // Set up request interception for API monitoring\n    await page.setRequestInterception(true);\n    const apiCalls: any[] = [];\n    \n    page.on('request', request => {\n      if (request.url().includes('/api/')) {\n        apiCalls.push({\n          url: request.url(),\n          method: request.method(),\n          timestamp: Date.now(),\n        });\n      }\n      request.continue();\n    });\n\n    // Store API calls for debugging\n    (page as any).apiCalls = apiCalls;\n  });\n\n  afterEach(async () => {\n    await page?.close();\n  });\n\n  describe('Chart Generation Journey', () => {\n    test('should complete full visualization workflow', async () => {\n      // Step 1: Navigate to visualization page\n      await page.goto(`${TEST_CONFIG.FRONTEND_URL}/research/${testResearchId}/visualization`);\n      \n      // Wait for page to load\n      await page.waitForSelector('[data-testid=\"visualization-page\"]', { timeout: 10000 });\n      \n      // Step 2: Upload or input sample data\n      const sampleData = {\n        groups: ['Control', 'Treatment A', 'Treatment B'],\n        outcomes: [5.2, 6.8, 7.3],\n        errors: [0.8, 1.1, 0.9],\n      };\n      \n      // Check if data input area exists\n      const dataInputExists = await page.$('[data-testid=\"data-input\"]');\n      if (dataInputExists) {\n        await page.click('[data-testid=\"data-input\"]');\n        await page.type('[data-testid=\"data-input\"]', JSON.stringify(sampleData));\n      }\n      \n      // Step 3: Select chart type\n      await page.waitForSelector('[data-testid=\"chart-type-selector\"]', { timeout: 5000 });\n      await page.click('[data-testid=\"chart-type-selector\"]');\n      await page.click('[data-testid=\"chart-type-bar\"]');\n      \n      // Step 4: Configure chart options\n      const titleInput = await page.$('[data-testid=\"chart-title-input\"]');\n      if (titleInput) {\n        await page.click('[data-testid=\"chart-title-input\"]');\n        await page.type('[data-testid=\"chart-title-input\"]', 'E2E Test Chart');\n      }\n      \n      const xLabelInput = await page.$('[data-testid=\"x-label-input\"]');\n      if (xLabelInput) {\n        await page.click('[data-testid=\"x-label-input\"]');\n        await page.type('[data-testid=\"x-label-input\"]', 'Treatment Groups');\n      }\n      \n      const yLabelInput = await page.$('[data-testid=\"y-label-input\"]');\n      if (yLabelInput) {\n        await page.click('[data-testid=\"y-label-input\"]');\n        await page.type('[data-testid=\"y-label-input\"]', 'Outcome Score');\n      }\n      \n      // Step 5: Generate chart\n      await page.click('[data-testid=\"generate-chart-button\"]');\n      \n      // Wait for chart generation (with loading indicator)\n      await page.waitForSelector('[data-testid=\"chart-loading\"]', { timeout: 5000 });\n      \n      // Wait for chart to be generated\n      await page.waitForSelector('[data-testid=\"generated-chart\"]', { \n        timeout: TEST_CONFIG.TIMEOUT,\n      });\n      \n      // Step 6: Verify chart appears\n      const chartElement = await page.$('[data-testid=\"generated-chart\"]');\n      expect(chartElement).toBeTruthy();\n      \n      // Verify chart has image\n      const chartImage = await page.$('[data-testid=\"chart-image\"]');\n      expect(chartImage).toBeTruthy();\n      \n      // Step 7: Check chart metadata\n      const chartTitle = await page.$eval(\n        '[data-testid=\"chart-title\"]',\n        el => el.textContent\n      );\n      expect(chartTitle).toContain('E2E Test Chart');\n      \n      // Step 8: Save chart to library\n      const saveButton = await page.$('[data-testid=\"save-chart-button\"]');\n      if (saveButton) {\n        await page.click('[data-testid=\"save-chart-button\"]');\n        \n        // Wait for save confirmation\n        await page.waitForSelector('[data-testid=\"save-success-message\"]', {\n          timeout: 10000,\n        });\n        \n        // Extract figure ID for cleanup\n        const figureId = await page.evaluate(() => {\n          const element = document.querySelector('[data-figure-id]');\n          return element?.getAttribute('data-figure-id');\n        });\n        \n        if (figureId) {\n          createdFigureIds.push(figureId);\n        }\n      }\n      \n    }, TEST_CONFIG.TIMEOUT * 2);\n\n    test('should handle multiple chart types', async () => {\n      const chartTypes = [\n        { type: 'line', data: { x: [1, 2, 3, 4, 5], y: [2, 4, 3, 5, 6] } },\n        { type: 'scatter', data: { x: [1, 2, 3, 4], y: [2, 3, 1, 4] } },\n        { type: 'box', data: { groups: ['A', 'B'], values: [[1, 2, 3, 4], [2, 3, 4, 5]] } },\n      ];\n      \n      for (const chartConfig of chartTypes) {\n        await page.goto(`${TEST_CONFIG.FRONTEND_URL}/research/${testResearchId}/visualization`);\n        \n        // Select chart type\n        await page.waitForSelector('[data-testid=\"chart-type-selector\"]');\n        await page.click('[data-testid=\"chart-type-selector\"]');\n        await page.click(`[data-testid=\"chart-type-${chartConfig.type}\"]`);\n        \n        // Input data (simplified)\n        const dataInput = await page.$('[data-testid=\"data-input\"]');\n        if (dataInput) {\n          await page.click('[data-testid=\"data-input\"]');\n          await page.keyboard.selectAll();\n          await page.type('[data-testid=\"data-input\"]', JSON.stringify(chartConfig.data));\n        }\n        \n        // Generate chart\n        await page.click('[data-testid=\"generate-chart-button\"]');\n        \n        // Verify chart generation\n        await page.waitForSelector('[data-testid=\"generated-chart\"]', {\n          timeout: TEST_CONFIG.TIMEOUT,\n        });\n        \n        const chart = await page.$('[data-testid=\"generated-chart\"]');\n        expect(chart).toBeTruthy();\n      }\n    }, TEST_CONFIG.TIMEOUT * 3);\n  });\n\n  describe('Figure Library Management', () => {\n    test('should browse and manage figure library', async () => {\n      // Navigate to figure library\n      await page.goto(`${TEST_CONFIG.FRONTEND_URL}/research/${testResearchId}/figures`);\n      \n      // Wait for library to load\n      await page.waitForSelector('[data-testid=\"figure-library\"]', { timeout: 10000 });\n      \n      // Check if there are any figures\n      const figureCards = await page.$$('[data-testid=\"figure-card\"]');\n      \n      if (figureCards.length > 0) {\n        // Test figure preview\n        await page.click('[data-testid=\"figure-card\"]:first-child');\n        \n        // Wait for figure modal/preview\n        await page.waitForSelector('[data-testid=\"figure-preview\"]', { timeout: 5000 });\n        \n        // Check figure details\n        const figureTitle = await page.$('[data-testid=\"figure-title\"]');\n        expect(figureTitle).toBeTruthy();\n        \n        const figureImage = await page.$('[data-testid=\"figure-image\"]');\n        expect(figureImage).toBeTruthy();\n        \n        // Test download functionality\n        const downloadButton = await page.$('[data-testid=\"download-figure-button\"]');\n        if (downloadButton) {\n          await page.click('[data-testid=\"download-figure-button\"]');\n          \n          // Verify download options\n          await page.waitForSelector('[data-testid=\"download-options\"]', { timeout: 3000 });\n          \n          const pngOption = await page.$('[data-testid=\"download-png\"]');\n          expect(pngOption).toBeTruthy();\n        }\n        \n        // Close modal\n        const closeButton = await page.$('[data-testid=\"close-figure-preview\"]');\n        if (closeButton) {\n          await page.click('[data-testid=\"close-figure-preview\"]');\n        }\n      }\n    });\n\n    test('should filter figures by type and status', async () => {\n      await page.goto(`${TEST_CONFIG.FRONTEND_URL}/research/${testResearchId}/figures`);\n      \n      await page.waitForSelector('[data-testid=\"figure-library\"]');\n      \n      // Test chart type filter\n      const typeFilter = await page.$('[data-testid=\"filter-by-type\"]');\n      if (typeFilter) {\n        await page.click('[data-testid=\"filter-by-type\"]');\n        await page.click('[data-testid=\"filter-type-bar-chart\"]');\n        \n        // Wait for filtered results\n        await page.waitForTimeout(1000);\n        \n        // Verify filter is applied\n        const activeFilter = await page.$('[data-testid=\"active-filter-bar-chart\"]');\n        expect(activeFilter).toBeTruthy();\n      }\n      \n      // Test PHI status filter\n      const statusFilter = await page.$('[data-testid=\"filter-by-status\"]');\n      if (statusFilter) {\n        await page.click('[data-testid=\"filter-by-status\"]');\n        await page.click('[data-testid=\"filter-status-pass\"]');\n        \n        await page.waitForTimeout(1000);\n        \n        const activeStatusFilter = await page.$('[data-testid=\"active-filter-pass\"]');\n        expect(activeStatusFilter).toBeTruthy();\n      }\n      \n      // Clear filters\n      const clearFilters = await page.$('[data-testid=\"clear-filters\"]');\n      if (clearFilters) {\n        await page.click('[data-testid=\"clear-filters\"]');\n        \n        await page.waitForTimeout(1000);\n        \n        // Verify filters are cleared\n        const noActiveFilters = await page.$('[data-testid=\"no-active-filters\"]');\n        expect(noActiveFilters).toBeTruthy();\n      }\n    });\n  });\n\n  describe('Error Handling and Edge Cases', () => {\n    test('should handle network errors gracefully', async () => {\n      await page.goto(`${TEST_CONFIG.FRONTEND_URL}/research/${testResearchId}/visualization`);\n      \n      // Simulate network failure\n      await page.setOfflineMode(true);\n      \n      // Try to generate chart\n      await page.click('[data-testid=\"chart-type-selector\"]');\n      await page.click('[data-testid=\"chart-type-bar\"]');\n      await page.click('[data-testid=\"generate-chart-button\"]');\n      \n      // Should show error message\n      await page.waitForSelector('[data-testid=\"error-message\"]', { timeout: 10000 });\n      \n      const errorMessage = await page.$('[data-testid=\"error-message\"]');\n      expect(errorMessage).toBeTruthy();\n      \n      const errorText = await page.$eval(\n        '[data-testid=\"error-message\"]',\n        el => el.textContent\n      );\n      expect(errorText).toContain('network');\n      \n      // Restore network\n      await page.setOfflineMode(false);\n    });\n\n    test('should validate data input', async () => {\n      await page.goto(`${TEST_CONFIG.FRONTEND_URL}/research/${testResearchId}/visualization`);\n      \n      await page.waitForSelector('[data-testid=\"chart-type-selector\"]');\n      \n      // Select chart type\n      await page.click('[data-testid=\"chart-type-selector\"]');\n      await page.click('[data-testid=\"chart-type-bar\"]');\n      \n      // Input invalid data\n      const dataInput = await page.$('[data-testid=\"data-input\"]');\n      if (dataInput) {\n        await page.click('[data-testid=\"data-input\"]');\n        await page.type('[data-testid=\"data-input\"]', 'invalid json data');\n      }\n      \n      // Try to generate chart\n      await page.click('[data-testid=\"generate-chart-button\"]');\n      \n      // Should show validation error\n      await page.waitForSelector('[data-testid=\"validation-error\"]', { timeout: 5000 });\n      \n      const validationError = await page.$('[data-testid=\"validation-error\"]');\n      expect(validationError).toBeTruthy();\n    });\n\n    test('should handle large datasets', async () => {\n      await page.goto(`${TEST_CONFIG.FRONTEND_URL}/research/${testResearchId}/visualization`);\n      \n      // Create large dataset\n      const largeData = {\n        x: Array.from({ length: 1000 }, (_, i) => i),\n        y: Array.from({ length: 1000 }, () => Math.random()),\n      };\n      \n      await page.waitForSelector('[data-testid=\"chart-type-selector\"]');\n      await page.click('[data-testid=\"chart-type-selector\"]');\n      await page.click('[data-testid=\"chart-type-scatter\"]');\n      \n      const dataInput = await page.$('[data-testid=\"data-input\"]');\n      if (dataInput) {\n        await page.click('[data-testid=\"data-input\"]');\n        await page.type('[data-testid=\"data-input\"]', JSON.stringify(largeData));\n      }\n      \n      // Generate chart with timeout\n      await page.click('[data-testid=\"generate-chart-button\"]');\n      \n      // Should either succeed or show appropriate message\n      const result = await Promise.race([\n        page.waitForSelector('[data-testid=\"generated-chart\"]', { timeout: TEST_CONFIG.TIMEOUT }),\n        page.waitForSelector('[data-testid=\"processing-large-data\"]', { timeout: 5000 }),\n        page.waitForSelector('[data-testid=\"timeout-error\"]', { timeout: TEST_CONFIG.TIMEOUT }),\n      ]);\n      \n      expect(result).toBeTruthy();\n    }, TEST_CONFIG.TIMEOUT * 2);\n  });\n\n  describe('Accessibility and Usability', () => {\n    test('should be keyboard navigable', async () => {\n      await page.goto(`${TEST_CONFIG.FRONTEND_URL}/research/${testResearchId}/visualization`);\n      \n      await page.waitForSelector('[data-testid=\"visualization-page\"]');\n      \n      // Tab through the interface\n      await page.keyboard.press('Tab');\n      await page.keyboard.press('Tab');\n      await page.keyboard.press('Tab');\n      \n      // Should be able to open chart type selector with keyboard\n      await page.keyboard.press('Enter');\n      \n      await page.waitForSelector('[data-testid=\"chart-type-options\"]', { timeout: 3000 });\n      \n      // Navigate chart types with arrow keys\n      await page.keyboard.press('ArrowDown');\n      await page.keyboard.press('Enter');\n      \n      // Should have selected a chart type\n      const selectedType = await page.$('[data-testid=\"selected-chart-type\"]');\n      expect(selectedType).toBeTruthy();\n    });\n\n    test('should provide proper alt text for charts', async () => {\n      // This would be tested if we have charts generated\n      await page.goto(`${TEST_CONFIG.FRONTEND_URL}/research/${testResearchId}/figures`);\n      \n      await page.waitForSelector('[data-testid=\"figure-library\"]');\n      \n      const figures = await page.$$('[data-testid=\"figure-image\"]');\n      \n      for (const figure of figures) {\n        const altText = await figure.getProperty('alt');\n        const altValue = await altText.jsonValue();\n        \n        // Should have meaningful alt text\n        expect(altValue).toBeTruthy();\n        expect(altValue.length).toBeGreaterThan(10);\n      }\n    });\n  });\n\n  describe('Performance Monitoring', () => {\n    test('should track API call performance', async () => {\n      await page.goto(`${TEST_CONFIG.FRONTEND_URL}/research/${testResearchId}/visualization`);\n      \n      const startTime = Date.now();\n      \n      // Perform chart generation\n      await page.waitForSelector('[data-testid=\"chart-type-selector\"]');\n      await page.click('[data-testid=\"chart-type-selector\"]');\n      await page.click('[data-testid=\"chart-type-bar\"]');\n      \n      const dataInput = await page.$('[data-testid=\"data-input\"]');\n      if (dataInput) {\n        await page.click('[data-testid=\"data-input\"]');\n        await page.type('[data-testid=\"data-input\"]', JSON.stringify({\n          groups: ['A', 'B', 'C'],\n          values: [1, 2, 3],\n        }));\n      }\n      \n      await page.click('[data-testid=\"generate-chart-button\"]');\n      \n      await page.waitForSelector('[data-testid=\"generated-chart\"]', {\n        timeout: TEST_CONFIG.TIMEOUT,\n      });\n      \n      const endTime = Date.now();\n      const totalTime = endTime - startTime;\n      \n      // Chart generation should complete in reasonable time\n      expect(totalTime).toBeLessThan(TEST_CONFIG.TIMEOUT);\n      \n      // Check API calls made during the process\n      const apiCalls = (page as any).apiCalls || [];\n      const visualizationCalls = apiCalls.filter((call: any) => \n        call.url.includes('/api/visualization/')\n      );\n      \n      expect(visualizationCalls.length).toBeGreaterThan(0);\n      \n      // Log performance metrics\n      console.log(`Chart generation completed in ${totalTime}ms`);\n      console.log(`API calls made: ${visualizationCalls.length}`);\n    }, TEST_CONFIG.TIMEOUT * 2);\n  });\n});"